name: IPTV to Telegram (go2rtc Zero-Lag)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      IPTV_URL: ${{ secrets.SOURCE_URL }}
      TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}

    steps:
      - name: Install go2rtc
        run: |
          wget https://github.com/AlexxIT/go2rtc/releases/latest/download/go2rtc_linux_amd64
          chmod +x go2rtc_linux_amd64
          sudo mv go2rtc_linux_amd64 /usr/local/bin/go2rtc

      - name: Create go2rtc config
        run: |
          mkdir -p ~/.config/go2rtc
          cat <<EOF > ~/.config/go2rtc/config.yaml
          streams:
            iptv:
              - "${IPTV_URL}"
          rtmp:
            telegram:
              url: "${TELEGRAM_URL}/${TELEGRAM_KEY}"
              input: iptv
          log:
            level: info
          server:
            api: ":1984"
          EOF

      - name: Launch go2rtc and monitor stream
        shell: bash
        run: |
          echo "Starting go2rtc..."
          nohup go2rtc > go2rtc.log 2>&1 &
          sleep 10

          echo "Waiting for stream to register..."
          for i in {1..10}; do
            curl -s http://localhost:1984/api/streams | grep -q '"iptv"' && break
            echo "Stream not found yet, retrying..."
            sleep 3
          done

          echo "Monitoring stream health..."
          while true; do
            curl -s http://localhost:1984/api/streams/iptv | grep -q '"status":"online"'
            if [ $? -ne 0 ]; then
              echo "Stream offline â€” restarting go2rtc..."
              pkill go2rtc || true
              nohup go2rtc > go2rtc.log 2>&1 &
              sleep 10
            fi
            sleep 5
          done
