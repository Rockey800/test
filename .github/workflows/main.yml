name: Telegram Live Stream (Auto Quality)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 140

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Start streaming with auto quality
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
          BUFFER_DELAY: 60   # seconds
        run: |
          set -e
          mkdir -p buffer

          echo "Starting writer (record source into 5s chunks)..."
          (
            while true; do
              ffmpeg -hide_banner -loglevel warning \
                -user_agent "VLC/3.0.20" \
                -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 \
                -reconnect_on_network_error 1 -reconnect_on_http_error 4xx,5xx \
                -reconnect_delay_max 10 \
                -i "$SOURCE_URL" \
                -c copy -f segment -segment_time 5 \
                -reset_timestamps 1 -strftime 1 "buffer/out-%Y%m%d-%H%M%S.ts" || true
              echo "[WRITER] crashed, retry in 5s..."
              sleep 5
            done
          ) &

          echo "Starting cleanup (delete >10 min old files)..."
          (
            while true; do
              find buffer -type f -mmin +10 -delete
              sleep 60
            done
          ) &

          echo "Waiting $BUFFER_DELAY sec to fill buffer..."
          sleep $BUFFER_DELAY

          echo "Starting reader (auto quality â†’ Telegram)..."
          while true; do
            ffmpeg -hide_banner -loglevel warning \
              -pattern_type glob -i "buffer/out-*.ts" \
              -fflags +genpts+discardcorrupt \
              -c:v libx264 -preset veryfast -tune zerolatency \
              -c:a aac -b:a 128k -ar 44100 -ac 2 \
              -f flv "rtmp://streaming.telegram.org/live/$TELEGRAM_KEY" || true
            echo "[READER] crashed, retry in 5s..."
            sleep 5
          done
