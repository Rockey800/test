- name: Start Telegram Live Stream with Segment Buffer (~30s delay)
  env:
    SOURCE_URL: "http://tvmate.icu:8080/7ES2xf/934197/1846"
    TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
    TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
  run: |
    mkdir -p segments

    # Producer: save IPTV stream into 1s TS segments
    ffmpeg -re -thread_queue_size 1024 \
      -i "$SOURCE_URL" -c copy \
      -f segment -segment_time 1 -reset_timestamps 1 \
      -strftime 1 "segments/out-%Y%m%d%H%M%S.ts" \
      -nostdin -loglevel warning &

    # Wait ~30s before starting consumer
    sleep 30

    # Consumer: read segments in order and push to Telegram
    while true; do
      for f in $(ls segments/*.ts | sort); do
        ffmpeg -re -thread_queue_size 1024 -i "$f" \
          -c:v libx264 -preset veryfast -b:v 2500k -vf "scale=1280:720" \
          -c:a aac -b:a 128k -ar 44100 -ac 2 \
          -f flv "$TELEGRAM_URL/$TELEGRAM_KEY" \
          -nostdin -loglevel warning
        rm -f "$f"
      done
      sleep 1
    done 
