name: Telegram IPTV â†’ 720p Live (No Reencode if Possible)

on:
  workflow_dispatch:
    inputs:
      stream_title:
        description: 'Live stream title'
        required: false
        default: 'IPTV Live @720p'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6-hour max (free tier)

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt update -qq
          sudo apt install -y ffmpeg

      - name: Stream to Telegram (720p - Copy or Transcode)
        env:
          TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
          IPTV_SOURCE_URL: ${{ secrets.IPTV_SOURCE_URL }}
        run: |
          echo "Starting 720p stream to Telegram..."
          
          # Try NO REENCODE first (only if source is H.264 + AAC)
          ffmpeg -y \
            -loglevel info \
            -re -i "$IPTV_SOURCE_URL" \
            -c:v copy -c:a copy \
            -vf "scale=-2:720" -r 30 \
            -f flv "$TELEGRAM_RTMP_URL" \
          || \
          # Fallback: Fast 720p transcode if copy fails
          ffmpeg -y \
            -loglevel warning \
            -re -i "$IPTV_SOURCE_URL" \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -vf "scale=-2:720" -r 30 \
            -c:a aac -b:a 128k -ar 44100 \
            -f flv "$TELEGRAM_RTMP_URL"