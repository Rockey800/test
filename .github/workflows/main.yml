# .github/workflows/neko-6hours.yml
name: Start N.eko (6-hour max – 2G proof)

on:
  workflow_dispatch:

jobs:
  run-neko:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create perfect 2G docker-compose.yml
        run: |
          cat > docker-compose.yml <<'EOF'
          version: "3.8"
          services:
            neko:
              image: ghcr.io/m1k1o/neko:firefox
              restart: unless-stopped
              shm_size: "2gb"
              ports:
                - "8080:8080/tcp"
                - "59000-59100:59000-59100/udp"
              environment:
                - NEKO_PASSWORD=2gparty
                - NEKO_PASSWORD_ADMIN=admin123
                - NEKO_VIDEO_CODEC=vp8
                - NEKO_VIDEO_BITRATE=20          # ← 20 kbps = real 2G works
                - NEKO_VIDEO_FPS=8
                - NEKO_VIDEO_RESOLUTION=480p
                - NEKO_MAX_FPS=15
                - NEKO_AUDIO_BITRATE=16
                - NEKO_EPR=59000-59100
          EOF

      - name: Start N.eko
        run: docker compose up -d

      - name: Show link & keep alive for ~6 hours
        run: |
          IP=$(curl -s ifconfig.me)
          echo ""
          echo "N.EKO IS LIVE FOR THE NEXT 6 HOURS!"
          echo "Link → http://$IP:8080"
          echo "Password → 2gparty"
          echo "Create room and share the link with friends on 2G"
          echo ""
          for i in {1..70}; do
            sleep 300
            echo "Still running – $(( (70-i)*5 )) minutes left | http://$IP:8080"
          done

      - name: Goodbye
        run: echo "6 hours finished – runner stopped. Run again for new session"