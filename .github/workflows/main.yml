name: Telegram IPTV Stream

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max stream
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg python3-pip
          pip install streamlink

      - name: Start IPTV stream to Telegram
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
          TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
        run: |
          echo "Starting stream from $SOURCE_URL to $TELEGRAM_URL/$TELEGRAM_KEY"
          until streamlink "$SOURCE_URL" best -O | \
          ffmpeg -re -i - -c copy -f flv "$TELEGRAM_URL/$TELEGRAM_KEY"; do
            echo "Stream crashed. Restarting in 5 seconds..."
            sleep 5
          done
