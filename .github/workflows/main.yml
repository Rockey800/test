name: IPTV to Telegram (SRS Relay)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      IPTV_URL: ${{ secrets.SOURCE_URL }}
      TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}

    steps:
      - name: Install SRS
        run: |
          git clone https://github.com/ossrs/srs.git
          cd srs/trunk
          ./configure && make -j$(nproc)
          sudo cp objs/srs /usr/local/bin/srs

      - name: Create SRS config
        run: |
          mkdir -p ~/.srs
          cat <<EOF > ~/.srs/srs.conf
          listen              1935;
          max_connections     1000;
          daemon              off;
          srs_log_tank        console;

          vhost __defaultVhost__ {
              enabled         on;

              ingest livestream {
                  enabled     on;
                  input {
                      type    stream;
                      url     ${IPTV_URL};
                  }
                  ffmpeg {
                      enabled on;
                      engine  default;
                  }
                  output {
                      type    rtmp;
                      url     ${TELEGRAM_URL}/${TELEGRAM_KEY};
                  }
              }
          }
          EOF

      - name: Start SRS relay
        run: |
          echo "Starting SRS relay..."
          nohup srs -c ~/.srs/srs.conf > srs.log 2>&1 &
          sleep 10
          echo "Stream should now be live on Telegram."

      - name: Keep job alive
        run: |
          echo "Maintaining session..."
          while true; do sleep 60; done
