name: ESPN4 Live Stream Kiosk (3h)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DISPLAY: :99
      TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
      CHROME_EXTENSION_PATH: /home/runner/chrome-extensions/ublock-origin
      PAGE_URL: https://rojadirectatv.cv/espn4.php
      CROP: "1280:720:0:180"  # Set to "" to disable

    steps:
      # ------------------------------------------------------------------
      # 1. Install Dependencies (libasound2t64 + unzip)
      # ------------------------------------------------------------------
      - name: Install system packages
        run: |
          sudo apt update -qq
          sudo apt install -y \
            nginx libnginx-mod-rtmp xvfb ffmpeg nodejs npm build-essential \
            wget unzip git pulseaudio \
            libxss1 libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 \
            libatspi2.0-0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
            libgtk-3-0 libasound2t64

      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt update -qq
          sudo apt install -y google-chrome-stable

      - name: Install Puppeteer
        run: sudo npm install -g puppeteer

      # ------------------------------------------------------------------
      # 2. Download uBlock Origin (FIXED: Direct GitHub ZIP)
      # ------------------------------------------------------------------
      - name: Download uBlock Origin (GitHub)
        run: |
          mkdir -p ~/chrome-extensions
          cd ~/chrome-extensions
          wget -q https://github.com/gorhill/uBlock/releases/download/1.58.0/uBlock0_1.58.0.chromium.zip -O ublock.zip
          unzip -q ublock.zip -d ublock-origin
          echo "uBlock Origin loaded from GitHub (v1.58.0)"

      # ------------------------------------------------------------------
      # 3. Create kiosk-stream.js
      # ------------------------------------------------------------------
      - name: Create kiosk-stream.js
        run: |
          cat > ~/kiosk-stream.js << 'EOF'
          const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              headless: false,
              executablePath: '/usr/bin/google-chrome-stable',
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
                '--no-first-run',
                '--window-size=1920,1080',
                '--start-maximized',
                '--autoplay-policy=no-user-gesture-required',
                '--disable-web-security',
                '--allow-running-insecure-content',
                `--disable-extensions-except=${process.env.CHROME_EXTENSION_PATH}`,
                `--load-extension=${process.env.CHROME_EXTENSION_PATH}`
              ],
              defaultViewport: { width: 1920, height: 1080 }
            });

            const page = await browser.newPage();
            console.log('Loading ESPN4...');
            await page.goto(process.env.PAGE_URL, { waitUntil: 'networkidle2', timeout: 60000 });

            await page.waitForSelector('video, iframe, .player', { timeout: 30000 }).catch(() => {
              console.log('Player not detected, but continuing...');
            });

            console.log('Stream live with uBlock + fullscreen');
            await new Promise(() => {});
          })();
          EOF

      # ------------------------------------------------------------------
      # 4. Create start-stream.sh
      # ------------------------------------------------------------------
      - name: Create start-stream.sh
        run: |
          cat > ~/start-stream.sh << 'EOF'
          #!/bin/bash
          set -e

          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          sleep 3

          node ~/kiosk-stream.js &
          CHROME_PID=$!

          sleep 15

          CROP_FILTER=""
          if [ -n "$CROP" ] && [ "$CROP" != "none" ]; then
            CROP_FILTER="-vf crop=$CROP"
          fi

          ffmpeg -f x11grab -video_size 1920x1080 -framerate 30 -i :99 \
            $CROP_FILTER \
            -c:v libx264 -preset fast -b:v 3000k -maxrate 3000k -bufsize 6000k \
            -g 60 -keyint_min 60 \
            -c:a aac -b:a 160k -ar 44100 \
            -f flv rtmp://localhost/live/stream

          kill $CHROME_PID || true
          pkill Xvfb || true
          EOF
          chmod +x ~/start-stream.sh

      # ------------------------------------------------------------------
      # 5. Configure Nginx RTMP
      # ------------------------------------------------------------------
      - name: Configure Nginx
        run: |
          [ -z "$TELEGRAM_RTMP_URL" ] && { echo "MISSING TELEGRAM_RTMP_URL"; exit 1; }

          sudo bash -c "cat > /etc/nginx/nginx.conf" << EOF
          user  nginx;
          worker_processes  auto;
          error_log /var/log/nginx/error.log warn;
          pid /run/nginx.pid;

          events { worker_connections 1024; }

          rtmp {
              server {
                  listen 1935;
                  chunk_size 4096;
                  application live {
                      live on;
                      record off;
                      allow publish 127.0.0.1;
                      deny publish all;
                      push $TELEGRAM_RTMP_URL;
                  }
              }
          }
          EOF

          sudo nginx -t && sudo systemctl restart nginx

      # ------------------------------------------------------------------
      # 6. RUN 3-HOUR STREAM
      # ------------------------------------------------------------------
      - name: Start 3-hour stream
        run: |
          echo "Starting ESPN4 â†’ Telegram (3h max)..."
          timeout 10800 ~/start-stream.sh || echo "Stream ended."

      # ------------------------------------------------------------------
      # 7. Cleanup
      # ------------------------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          sudo pkill -f chrome || true
          sudo pkill Xvfb || true
          sudo systemctl stop nginx || true