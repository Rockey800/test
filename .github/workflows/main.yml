name: Telegram Live Stream (via Docker RTMP)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # ~5h max

    steps:
      - name: Install Docker
        run: |
          sudo apt update
          sudo apt install -y docker.io

      - name: Start Nginx RTMP Docker
        run: |
          docker run -d --name nginx-rtmp -p 1935:1935 alfg/nginx-rtmp

      - name: Start Streaming
        env:
          SOURCE_URL: "http://tvmate.icu:8080/7ES2xf/934197/1847"   # replace with your source
          TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}       # e.g. rtmps://dc3-1.rtmp.t.me/s
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
        run: |
          # Push unstable source into local RTMP server (acts as buffer)
          nohup ffmpeg -re -i "$SOURCE_URL" \
            -c copy -f flv rtmp://localhost:1935/live/stream > push.log 2>&1 &

          # Pull from local RTMP and send to Telegram
          ffmpeg -re -i rtmp://localhost:1935/live/stream \
            -c:v libx264 -preset veryfast -b:v 2500k -vf "scale=1280:720" \
            -c:a aac -b:a 128k -ar 44100 -ac 2 \
            -f flv "$TELEGRAM_URL/$TELEGRAM_KEY"
