name: Telegram Live Stream (720p)
on:
  workflow_dispatch:
jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
      - name: Start Telegram Live Stream with FIFO buffer
        env:
          SOURCE_URL: "http://drewlive24.duckdns.org:4123?url=https%3A%2F%2Fdokko1new.newkso.ru%2Fdokko1%2Fpremium590%2Fmono.m3u8&data=T3JpZ2luPWh0dHBzOi8vZm9yY2VkdG9wbGF5Lnh5enxSZWZlcmVyPWh0dHBzOi8vZm9yY2VkdG9wbGF5Lnh5ei98VXNlci1hZ2VudD1Nb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0OyBydjoxMzkuMCkgR2Vja28vMjAxMDAxMDEgRmlyZWZveC8xMzkuMA%3D%3D"
          TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
        run: |
          set -e
          FIFO_NAME="buffer.ts"
          echo "Creating FIFO..."
          mkfifo "$FIFO_NAME" || { echo "Failed to create FIFO"; exit 1; }
          
          echo "Checking source stream..."
          ffprobe -v error "$SOURCE_URL" || { echo "Source stream unavailable"; exit 1; }
          
          echo "Starting source stream into FIFO..."
          ffmpeg -loglevel debug -y -reconnect 1 -reconnect_streamed 1 -reconnect_delay_max 60 \
            -i "$SOURCE_URL" -c copy -f mpegts "$FIFO_NAME" &
          FIFO_PID=$!
          
          echo "Starting Telegram stream..."
          ffmpeg -loglevel debug -re -i "$FIFO_NAME" \
            -vf "scale=1280:720,fps=25,setpts=N/FRAME_RATE/TB" \
            -c:v libx264 -preset ultrafast -b:v 2500k -flags +global_header \
            -c:a aac -b:a 128k -ar 44100 -ac 2 \
            -f flv "$TELEGRAM_URL/$TELEGRAM_KEY" || { echo "Telegram stream failed"; kill $FIFO_PID; exit 1; }
          
          wait $FIFO_PID