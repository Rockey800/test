name: IPTV to Telegram via FIFO (Buffered, Stable)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      IPTV_URL: ${{ secrets.SOURCE_URL }}
      TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
      BUFFER_SECONDS: "60"
      FIFO_PATH: "/tmp/stream_fifo.flv"

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Create FIFO pipe (clean reset)
        run: |
          echo "Resetting FIFO pipe at $FIFO_PATH"
          rm -f "$FIFO_PATH"
          mkfifo "$FIFO_PATH"

      - name: Push IPTV to FIFO (Retry Enabled)
        run: |
          while true; do
            echo "Starting IPTV push to FIFO..."
            ffmpeg -user_agent "VLC/3.0.20" \
              -timeout 10000000 -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 10 \
              -i "$IPTV_URL" \
              -use_wallclock_as_timestamps 1 -avoid_negative_ts make_zero \
              -c copy -f flv "$FIFO_PATH" || true
            echo "IPTV push crashed. Retrying in 5s..."
            sleep 5
          done &
          sleep 10

      - name: Buffer for 1 minute before Telegram push
        run: |
          echo "Waiting for 1-minute buffer..."
          sleep "$BUFFER_SECONDS"

      - name: Push FIFO stream to Telegram (Retry Enabled, Video Fixed)
        run: |
          while true; do
            echo "Starting Telegram push..."
            ffmpeg \
              -fflags +genpts -fflags nobuffer -flags low_delay \
              -use_wallclock_as_timestamps 1 -avoid_negative_ts make_zero \
              -i "$FIFO_PATH" \
              -map 0:v:0 -map 0:a:0 \
              -c:v copy -c:a copy \
              -flvflags no_duration_filesize \
              -f flv "${TELEGRAM_URL}/${TELEGRAM_KEY}" || true
            echo "Telegram push crashed. Retrying in 5s..."
            sleep 5
          done
