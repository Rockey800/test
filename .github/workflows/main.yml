name: "Headless YouTube Playback Test Loop"

on:
  workflow_dispatch:

jobs:
  youtube-play-loop:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Playwright + Chromium
      run: |
        npm init -y
        npm install playwright
        npx playwright install --with-deps chromium

    - name: Play YouTube video 5 times (30s each, 1 min apart)
      run: |
        cat <<'EOF' > play.js
        const { chromium } = require('playwright');

        (async () => {
          const browser = await chromium.launch({ headless: true });
          const context = await browser.newContext();
          const url = "https://youtu.be/FNRsrDSPJnk?si=GV9EWtfCEJePhAML";

          for (let i = 1; i <= 5; i++) {
            const page = await context.newPage();
            console.log(`\nðŸŽ¬ Attempt ${i} - Playing video for 30s`);
            await page.goto(url, { waitUntil: "domcontentloaded" });
            await page.waitForSelector('video', { timeout: 15000 });
            await page.evaluate(() => {
              const video = document.querySelector('video');
              video.muted = true;
              video.play();
              console.log("âœ… Playback started");
            });
            await page.waitForTimeout(30000);
            console.log(`ðŸ›‘ Attempt ${i} finished`);
            await page.close();
            if (i < 5) {
              console.log("â³ Waiting 1 minute before next attempt...");
              await new Promise(r => setTimeout(r, 60000));
            }
          }

          await browser.close();
          console.log("âœ… All attempts completed successfully");
        })();
        EOF

        node play.js
