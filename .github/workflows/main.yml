name: IPTV → Telegram Live (3h) – PPS-FIXED

on: workflow_dispatch

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 190

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Stream with PPS Fix
        env:
          IPTV_SOURCE:       ${{ secrets.IPTV_SOURCE }}
          TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
        run: |
          echo "Starting PPS-robust stream..."

          ffmpeg -y \
            -loglevel error \
            -err_detect ignore_err \
            -fflags +genpts+igndts \
            -re \
            \
            -probesize 10000000 \
            -analyzeduration 10000000 \
            -skip_initial_bytes 1 \
            \
            -user_agent "Mozilla/5.0 (X11; Linux x86_64)" \
            -headers $'Host: 87.255.35.150\r\nConnection: keep-alive\r\n' \
            \
            -i "$IPTV_SOURCE" \
            \
            -vf "setpts=PTS-STARTPTS" \
            -c:v libx264 \
            -preset veryfast \
            -tune zerolatency \
            -profile:v baseline \
            -level 3.1 \
            -g 30 \
            -keyint_min 30 \
            -sc_threshold 0 \
            -bf 0 \
            -b:v 2500k \
            -maxrate 2500k \
            -bufsize 5000k \
            -pix_fmt yuv420p \
            -x264-params "nal-hrd=cbr:force-cfr=1" \
            \
            -c:a aac -b:a 128k -ac 2 -ar 44100 \
            -af "aresample=async=1:first_pts=0" \
            \
            -f flv \
            -t 03:00:00 \
            "$TELEGRAM_RTMP_URL"