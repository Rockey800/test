name: Telegram IPTV â†’ 720p (Robust, No Crash)

on:
  workflow_dispatch:
    inputs:
      stream_title:
        description: 'Stream title'
        required: false
        default: 'Live TV @720p'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt update -qq
          sudo apt install -y ffmpeg

      - name: Robust 720p Stream to Telegram
        env:
          TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
          IPTV_SOURCE_URL: ${{ secrets.IPTV_SOURCE_URL }}
          STREAM_TITLE: ${{ inputs.stream_title }}
        run: |
          echo "Starting ROBUST 720p stream (error-tolerant)..."
          
          ffmpeg -y \
            -fflags +genpts+discardcorrupt \
            -err_detect ignore_err \
            -re -i "$IPTV_SOURCE_URL" \
            \
            -c:v libx264 \
            -preset veryfast \
            -tune zerolatency \
            -profile:v high \
            -b:v 2500k \
            -maxrate 2500k \
            -bufsize 5000k \
            -g 60 \
            -r 30 \
            -vf "scale=trunc(oh*a/2)*2:720,format=yuv420p" \
            \
            -c:a aac \
            -b:a 128k \
            -ar 44100 \
            -ac 2 \
            \
            -f flv \
            -flvflags no_duration_filesize \
            \
            "$TELEGRAM_RTMP_URL"