name: Browser RDP via Cloudflare (noVNC)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Enable RDP
        run: pwsh ./setup_rdp.ps1

      - name: Start noVNC server
        run: pwsh ./start_noVNC.ps1

      - name: Download/Update Cloudflared
        run: pwsh ./download_update_cloudflared.ps1

      - name: Start Cloudflared Tunnel
        run: pwsh ./start_cloudflared.ps1

      - name: Keep workflow alive for 5 hours
        run: |
          $totalSeconds = 18000
          $interval = 300
          $loops = [math]::Ceiling($totalSeconds / $interval)
          for ($i=1; $i -le $loops; $i++) {
              Write-Host "$(Get-Date -Format 'HH:mm:ss') ‚è≥ Tunnel running..."
              Start-Sleep -Seconds $interval
          }
        shell: pwsh
