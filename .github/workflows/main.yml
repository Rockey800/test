name: Telegram Live Stream (Buffered 720p)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # max 5h
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Start Telegram Live Stream with Segment Buffer (~30s delay)
        env:
          SOURCE_URL: "http://tvmate.icu:8080/7ES2xf/934197/1846"
          TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
        run: |
          mkdir -p segments

          # Producer: save IPTV stream into 1s TS segments (copy only)
          ffmpeg -re -thread_queue_size 1024 \
            -i "$SOURCE_URL" -c copy \
            -f segment -segment_time 1 -reset_timestamps 1 \
            -strftime 1 "segments/out-%Y%m%d%H%M%S.ts" \
            -nostdin -loglevel warning &

          # Give producer ~30s head start
          sleep 30

          # Consumer: read segments and push to Telegram
          while true; do
            files=$(ls segments/*.ts 2>/dev/null | sort)
            for f in $files; do
              ffmpeg -re -thread_queue_size 1024 -i "$f" \
                -c:v libx264 -preset veryfast -b:v 2500k -vf "scale=1280:720" \
                -c:a aac -b:a 128k -ar 44100 -ac 2 \
                -f flv "$TELEGRAM_URL/$TELEGRAM_KEY" \
                -nostdin -loglevel warning
              rm -f "$f"
            done
            sleep 1
          done
