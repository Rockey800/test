name: IPTV → Telegram Live (3 h)

on:
  workflow_dispatch:   # Manual start from GitHub UI

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 190   # safety net (3 h 10 min)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Run 3-hour stream
        env:
          IPTV_SOURCE:       ${{ secrets.IPTV_SOURCE }}
          TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
        run: |
          echo "Streaming to Telegram (key hidden)..."
          
          ffmpeg \
            -y \
            -loglevel error \
            -fflags +genpts \
            -reconnect 1 \
            -reconnect_at_eof 1 \
            -reconnect_streamed 1 \
            -reconnect_delay_max 5 \
            \
            -user_agent "Mozilla/5.0 (X11; Linux x86_64)" \
            -headers $'Host: 87.255.35.150\r\nConnection: keep-alive\r\n' \
            \
            -i "$IPTV_SOURCE" \
            \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -g 50 -keyint_min 50 \
            -pix_fmt yuv420p \
            \
            -c:a aac -b:a 128k -ac 2 -ar 44100 \
            \
            -f flv \
            -t 03:00:00 \   # ← 3 hours exactly
            "$TELEGRAM_RTMP_URL"