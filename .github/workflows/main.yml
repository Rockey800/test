name: FINAL Self-Contained Streamer

on:
  workflow_dispatch:
    inputs:
      page_url:
        description: 'URL of the page to stream from'
        required: true
        default: 'https://www.redditsoccerstreams.name/hd-10/'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: 1. Install All Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends ffmpeg xvfb wget scrot nodejs npm
        
        # Install Google Chrome
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y ./google-chrome-stable_current_amd64.deb || true
        rm google-chrome-stable_current_amd64.deb

    - name: 2. Create Auto-Unmute Extension from Source
      run: |
        # Create the folder for the extension
        mkdir -p ./unmute-extension

        # Create the manifest.json file
        cat <<'EOF' > ./unmute-extension/manifest.json
        {
          "manifest_version": 3,
          "name": "Auto Unmute",
          "version": "1.0",
          "description": "Automatically unmutes videos on page load.",
          "permissions": ["scripting"],
          "host_permissions": ["<all_urls>"],
          "background": {
            "service_worker": "background.js"
          }
        }
        EOF

        # Create the background.js service worker
        cat <<'EOF' > ./unmute-extension/background.js
        chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
          if (changeInfo.status === 'complete' && tab.url) {
            chrome.scripting.executeScript({
              target: { tabId: tabId },
              func: () => {
                const videos = document.querySelectorAll('video');
                videos.forEach(video => {
                  video.muted = false;
                });
              }
            });
          }
        });
        EOF

        echo "‚úÖ Auto-unmute extension created successfully from source."

    - name: 3. Setup Puppeteer and Create Automation Script
      run: |
        npm i puppeteer-extra puppeteer-extra-plugin-stealth puppeteer-extra-plugin-adblocker

        # Create the final automation script (start.js)
        cat <<'EOF' > start.js
        const puppeteer = require('puppeteer-extra');
        const StealthPlugin = require('puppeteer-extra-plugin-stealth');
        const AdblockerPlugin = require('puppeteer-extra-plugin-adblocker');

        puppeteer.use(StealthPlugin());
        puppeteer.use(AdblockerPlugin({ blockTrackers: true }));

        (async () => {
          const EXTENSION_PATH = './unmute-extension';

          console.log('üöÄ Launching browser with locally created Auto-Unmute extension...');
          const browser = await puppeteer.launch({
            headless: false,
            executablePath: '/usr/bin/google-chrome',
            ignoreDefaultArgs: ['--mute-audio'],
            args: [
              '--no-sandbox', '--disable-gpu', '--disable-dev-shm-usage',
              '--window-size=1280,720', '--display=:99',
              `--disable-extensions-except=${EXTENSION_PATH}`,
              `--load-extension=${EXTENSION_PATH}`
            ]
          });

          const page = await browser.newPage();
          await page.setViewport({ width: 1280, height: 720 });
          
          console.log(' Navigating to page...');
          await page.goto('${{ github.event.inputs.page_url }}', { waitUntil: 'networkidle2' });

          console.log('‚úÖ Page loaded. Clicking body to start video...');
          await new Promise(resolve => setTimeout(resolve, 10000));
          await page.click('body');
          console.log('‚úÖ Initial click sent. The extension will handle unmuting.');

          await new Promise(resolve => setTimeout(resolve, 3000));

          console.log('üì∫ Forcing video to fullscreen...');
          try {
            await page.evaluate(() => {
              document.querySelector('video').requestFullscreen();
            });
            console.log('‚úÖ Fullscreen request sent.');
          } catch (error) {
            console.error('‚ùå Could not find video element to make fullscreen.');
          }
        })();
        EOF

    - name: 4. Start High-Quality, Smooth Stream
      env:
        TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
      run: |
        echo "‚úÖ Starting virtual display..."
        Xvfb :99 -screen 0 1280x720x24 &
        echo "‚úÖ Running final automation script..."
        node start.js &
        echo "‚è≥ Waiting 30 seconds for all automation to complete..."
        sleep 30
        
        echo "üöÄ Starting FINAL FFmpeg stream..."
        ffmpeg -nostdin \
               -f x11grab -draw_mouse 0 -r 30 -s 1280x720 -i :99 \
               -c:v libx264 -preset veryfast -b:v 3500k -maxrate 4000k -bufsize 7000k -pix_fmt yuv420p -g 60 \
               -c:a aac -b:a 160k -ar 44100 \
               -f flv "$TELEGRAM_RTMP_URL"
