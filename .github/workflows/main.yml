name: Telegram Stream via NGINX RTMP

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      IPTV_URL: ${{ secrets.SOURCE_URL }}
      TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libpcre3 libpcre3-dev libssl-dev zlib1g-dev build-essential

      - name: Build NGINX with RTMP
        run: |
          git clone https://github.com/arut/nginx-rtmp-module.git
          wget http://nginx.org/download/nginx-1.25.2.tar.gz
          tar -zxvf nginx-1.25.2.tar.gz
          cd nginx-1.25.2
          ./configure --with-http_ssl_module --add-module=../nginx-rtmp-module
          make
          sudo make install

      - name: Configure NGINX
        run: |
          cat <<EOF | sudo tee /usr/local/nginx/conf/nginx.conf
          worker_processes  1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  chunk_size 4096;
                  application live {
                      live on;
                      record off;
                  }
              }
          }
          http {
              server {
                  listen 8080;
                  location / {
                      root html;
                  }
              }
          }
          EOF

      - name: Start NGINX
        run: sudo /usr/local/nginx/sbin/nginx

      - name: Push IPTV to NGINX
        run: |
          ffmpeg -user_agent "VLC/3.0.20" \
            -i "$IPTV_URL" \
            -c copy -f flv rtmp://localhost/live/stream &
          sleep 10

      - name: Push NGINX stream to Telegram
        run: |
          ffmpeg -i rtmp://localhost/live/stream \
            -c copy -f flv "${TELEGRAM_URL}/${TELEGRAM_KEY}"
