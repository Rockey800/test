name: IPTV to Telegram via NGINX RTMP (Buffered)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      IPTV_URL: ${{ secrets.SOURCE_URL }}
      TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
      BUFFER_SECONDS: "60"

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libpcre3 libpcre3-dev libssl-dev zlib1g-dev build-essential

      - name: Build NGINX with RTMP
        run: |
          git clone https://github.com/arut/nginx-rtmp-module.git
          wget http://nginx.org/download/nginx-1.25.2.tar.gz
          tar -zxvf nginx-1.25.2.tar.gz
          cd nginx-1.25.2
          ./configure --with-http_ssl_module --add-module=../nginx-rtmp-module
          make
          sudo make install

      - name: Configure NGINX
        run: |
          cat <<EOF | sudo tee /usr/local/nginx/conf/nginx.conf
          worker_processes  1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  chunk_size 4096;
                  application live {
                      live on;
                      record off;
                  }
              }
          }
          http {
              server {
                  listen 8080;
                  location / {
                      root html;
                  }
              }
          }
          EOF

      - name: Start NGINX
        run: sudo /usr/local/nginx/sbin/nginx

      - name: Push IPTV to NGINX (Retry Enabled)
        run: |
          while true; do
            echo "Starting IPTV push to NGINX..."
            ffmpeg -user_agent "VLC/3.0.20" \
              -timeout 10000000 -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 10 \
              -i "$IPTV_URL" \
              -use_wallclock_as_timestamps 1 -avoid_negative_ts make_zero \
              -c copy -f flv rtmp://localhost/live/stream || true
            echo "IPTV push crashed. Retrying in 5s..."
            sleep 5
          done &
          sleep 10

      - name: Buffer for 1 minute before Telegram push
        run: |
          echo "Waiting for 1-minute buffer..."
          sleep "$BUFFER_SECONDS"

      - name: Push NGINX stream to Telegram (Retry Enabled, Video Fixed)
        run: |
          while true; do
            echo "Starting Telegram push..."
            ffmpeg \
              -fflags +genpts -fflags nobuffer -flags low_delay \
              -use_wallclock_as_timestamps 1 -avoid_negative_ts make_zero \
              -i rtmp://localhost/live/stream \
              -map 0:v:0 -map 0:a:0 \
              -c:v copy -c:a copy \
              -flvflags no_duration_filesize \
              -f flv "${TELEGRAM_URL}/${TELEGRAM_KEY}" || true
            echo "Telegram push crashed. Retrying in 5s..."
            sleep 5
          done
