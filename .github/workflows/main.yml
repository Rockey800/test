name: Browser RDP via Cloudflare

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Enable RDP
        run: pwsh ./setup_rdp.ps1

      - name: Start Guacamole Server
        run: pwsh ./start_guacamole.ps1

      - name: Download/Update Cloudflared
        run: pwsh ./download_update_cloudflared.ps1

      - name: Start Cloudflared Tunnel
        run: pwsh ./start_cloudflared.ps1

      - name: Output public URL
        run: pwsh -Command "Get-Content 'C:\\ProgramData\\cloudflared\\public_url.txt'"

      - name: Keep workflow alive for 5 hours
        run: |
          $totalSeconds = 18000
          $interval = 300 # log every 5 minutes
          $loops = [math]::Ceiling($totalSeconds / $interval)

          for ($i=1; $i -le $loops; $i++) {
              Write-Host "$(Get-Date -Format 'HH:mm:ss') ‚è≥ Tunnel still running..."
              Start-Sleep -Seconds $interval
          }
        shell: pwsh
