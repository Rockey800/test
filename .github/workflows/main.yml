- name: Start Xvfb + PulseAudio (with null sink)
        run: |
          Xvfb :99 -screen 0 1280x720x24 +extension GLX +render -nolisten tcp &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          pulseaudio --start --exit-idle-time=-1
          sleep 3
          pactl load-module module-null-sink sink_name=VirtualSink sink_properties=device.description=VirtualSink
          pactl load-module module-loopback source=VirtualSink.monitor
          pactl set-default-sink VirtualSink
          echo "Audio routing ready!"

      - name: Launch mpv
        run: |
          mpv "$IPTV_SOURCE" \
            --vo=x11 \
            --hwdec=no \
            --loop=inf \
            --geometry=1280x720 \
            --title="iptv-live" \
            --audio-device=pulse/VirtualSink \
            --cache=yes --demuxer-max-bytes=50M --demuxer-readahead-secs=10 \
            --no-terminal --really-quiet \
            &> mpv.log &
          echo "mpv started."

      - name: Stream to Telegram
        run: |
          ffmpeg \
            -thread_queue_size 512 \
            -fflags +nobuffer \
            -use_wallclock_as_timestamps 1 \
            -f x11grab -draw_mouse 0 -video_size 1280x720 -framerate 30 -i :99.0 \
            -f pulse -i VirtualSink.monitor -ac 2 -ar 44100 \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 2500k -maxrate 3000k -bufsize 6000k \
            -g 60 -keyint_min 30 -bf 0 \
            -c:a aac -b:a 128k \
            -f flv "$TELEGRAM_SOURCE_URL"
