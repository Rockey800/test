name: Windows RDP (LocalXpose)
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download LocalXpose
        run: |
          Invoke-WebRequest https://api.localxpose.io/downloads/lxproxy.exe -OutFile lxproxy.exe

      - name: Set RDP password
        run: |
          net user runneradmin "MySecureP@ss123"
          echo "RDP Password set to: MySecureP@ss123"

      - name: Enable RDP and Firewall
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Start LocalXpose tunnel
        env:
          TOKEN: ${{ secrets.LOCALXPOSE_TOKEN }}
        run: |
          Start-Process -NoNewWindow -FilePath ".\lxproxy.exe" -ArgumentList "authtoken", "$env:TOKEN"
          Start-Sleep -Seconds 5
          .\lxproxy.exe tcp 3389 --region ap &
          Start-Sleep -Seconds 10

      - name: Keep alive
        run: |
          while ($true) { Start-Sleep -Seconds 3600 }
