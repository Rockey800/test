name: Stream PHP page to Telegram
on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y ffmpeg xvfb wget unzip
        # Install headless Chrome
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt install -y ./google-chrome-stable_current_amd64.deb || true

    - name: Start streaming
      env:
        TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
        TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
      run: |
        echo "Starting virtual display..."
        export DISPLAY=:99
        Xvfb :99 -screen 0 1280x720x24 &

        echo "Launching headless Chrome for PHP page..."
        google-chrome --no-sandbox --headless --disable-gpu "https://www.touristy.top/frame/11.php" &
        sleep 5  # wait for page to load

        echo "Starting FFmpeg stream to Telegram..."
        RTMP_TARGET="rtmp://${TELEGRAM_URL}/${TELEGRAM_KEY}"
        ffmpeg -f x11grab -r 30 -s 1280x720 -i :99 \
               -c:v libx264 -preset ultrafast -pix_fmt yuv420p \
               -c:a aac -b:a 128k \
               -f flv "$RTMP_TARGET"