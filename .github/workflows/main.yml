name: IPTV â†’ Telegram Live (3 Hours, No Restart)

on:
  workflow_dispatch:  # Manual trigger ONLY

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 195  # 3h15m buffer (GitHub max per job ~6h)

    steps:
      - name: Install Latest FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg

      - name: Stream (3 Hours Max, Auto-Reconnect on Crash)
        env:
          TELEGRAM_RTMP_URL: ${{ secrets.TELEGRAM_RTMP_URL }}
          IPTV_SOURCE: ${{ secrets.IPTV_SOURCE }}
        run: |
          END_TIME=$(($(date +%s) + 10800))  # 3 hours = 10800 seconds

          while [ $(date +%s) -lt $END_TIME ]; do
            ffmpeg \
              -loglevel error \
              -re \
              -fflags +genpts+discardcorrupt \
              -i "$IPTV_SOURCE" \
              -c:v copy \
              -c:a copy \
              -bsf:a aac_adtstoasc \
              -f flv \
              "$TELEGRAM_RTMP_URL" \
              || echo "Stream dropped. Reconnecting in 10s..."

            sleep 10
          done

          echo "3-hour stream finished. Stopped at $(date)."