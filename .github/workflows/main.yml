name: Telegram Live Stream (Buffered + 2-min repair)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 150

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Start streaming
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          TELEGRAM_URL: ${{ secrets.TELEGRAM_URL }}
          TELEGRAM_KEY: ${{ secrets.TELEGRAM_KEY }}
          BUFFER_SECONDS: 30
          SEGMENT_SECONDS: 2
          USER_AGENT: VLC/3.0.20
          REPAIR_BUFFER_SECONDS: 120
          REPAIR_SEGMENT_SECONDS: 2
          REPAIR_DIR: repair_segments
        run: |
          set -e
          mkdir -p segments
          mkdir -p $REPAIR_DIR

          DELAY_SEGMENTS=$((BUFFER_SECONDS / SEGMENT_SECONDS))
          REPAIR_DELAY_SEGMENTS=$((REPAIR_BUFFER_SECONDS / REPAIR_SEGMENT_SECONDS))

          echo "Buffer $BUFFER_SECONDS s | Segment $SEGMENT_SECONDS s | Delay $DELAY_SEGMENTS segments"
          echo "Repair buffer $REPAIR_BUFFER_SECONDS s | Segment $REPAIR_SEGMENT_SECONDS s | Delay $REPAIR_DELAY_SEGMENTS segments"

          # Original writer loop (starts immediately)
          writer_loop() {
            while true; do
              echo "[WRITER] starting $(date)"
              ffmpeg -hide_banner -loglevel warning \
                -user_agent "$USER_AGENT" \
                -timeout 10000000 \
                -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 10 \
                -i "$SOURCE_URL" \
                -c copy -f hls \
                -hls_time $SEGMENT_SECONDS \
                -hls_list_size 0 \
                -hls_flags delete_segments+append_list+omit_endlist \
                segments/stream.m3u8 || true
              echo "[WRITER] crashed, retry in 5s..."
              sleep 5
            done
          }

          # Repair writer loop (2-min rolling buffer)
          repair_writer_loop() {
            while true; do
              echo "[REPAIR WRITER] starting $(date)"
              ffmpeg -hide_banner -loglevel warning \
                -user_agent "$USER_AGENT" \
                -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 10 \
                -i "$SOURCE_URL" \
                -c copy -f segment \
                -segment_time $REPAIR_SEGMENT_SECONDS \
                -segment_wrap $REPAIR_DELAY_SEGMENTS \
                "$REPAIR_DIR/buffer_%03d.ts" || true
              echo "[REPAIR WRITER] crashed, retry in 5s..."
              sleep 5
            done
          }

          # Reader: reads original segments for instant start
          reader_loop() {
            sleep $BUFFER_SECONDS
            echo "Buffer ready, starting Telegram stream..."
            while true; do
              echo "[READER] starting $(date)"
              ffmpeg -hide_banner -loglevel warning \
                -i "segments/stream.m3u8" \
                -live_start_index -$DELAY_SEGMENTS \
                -fflags +genpts \
                -c:v libx264 -preset veryfast -b:v 2500k -vf "scale=1280:720" \
                -c:a aac -b:a 128k -ar 44100 -ac 2 \
                -f flv "$TELEGRAM_URL/$TELEGRAM_KEY" || true
              echo "[READER] crashed, retrying in 5s..."
              sleep 5
            done
          }

          # Start both writers in background
          writer_loop > segments/writer.log 2>&1 &
          repair_writer_loop > $REPAIR_DIR/writer.log 2>&1 &

          # Start reader immediately
          reader_loop > segments/reader.log 2>&1
