name: RDP via noVNC + Cloudflare

on:
  workflow_dispatch:

jobs:
  rdp-web:
    runs-on: windows-latest
    timeout-minutes: 300  # 5 hours

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install websockify
      - name: Install websockify
        run: |
          python -m pip install --upgrade pip
          pip install websockify

      # 4Ô∏è‚É£ Download noVNC
      - name: Download noVNC
        run: |
          $noVNCDir = "C:\noVNC"
          if (-Not (Test-Path "$noVNCDir")) { New-Item -Path $noVNCDir -ItemType Directory }
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "$noVNCDir\noVNC.zip"
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory("$noVNCDir\noVNC.zip", $noVNCDir)
          Remove-Item "$noVNCDir\noVNC.zip"
          Write-Host "‚úÖ noVNC downloaded"

      # 5Ô∏è‚É£ Start websockify for RDP
      - name: Start websockify
        run: |
          $noVNCDir = "C:\noVNC\noVNC-master\utils\websockify"
          $pythonExe = "C:\hostedtoolcache\windows\Python\3.11.9\x64\python.exe"
          Write-Host "üöÄ Starting websockify for RDP..."
          Start-Process -FilePath $pythonExe -ArgumentList "$noVNCDir\run", "-v", "5900", "--wrap-mode=rdp", "localhost", "3389" -WindowStyle Hidden

          # Wait for port 5900
          $maxTries = 20
          $connected = $false
          for ($i=1; $i -le $maxTries; $i++) {
              try {
                  $tcp = New-Object System.Net.Sockets.TcpClient("127.0.0.1", 5900)
                  $tcp.Close()
                  $connected = $true
                  break
              } catch {}
              Start-Sleep -Seconds 3
          }
          if (-not $connected) {
              Write-Warning "‚ö†Ô∏è Websockify did not start on port 5900."
              exit 1
          } else {
              Write-Host "‚úÖ Websockify running on http://localhost:5900"
          }

      # 6Ô∏è‚É£ Download Cloudflared
      - name: Download Cloudflared
        run: |
          $cfDir = "C:\cloudflared"
          if (-Not (Test-Path $cfDir)) { New-Item -Path $cfDir -ItemType Directory }
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$cfDir\cloudflared.exe"
          Write-Host "‚úÖ Cloudflared downloaded"

      # 7Ô∏è‚É£ Start Cloudflare Tunnel (quick tunnel)
      - name: Start Cloudflare Tunnel
        run: |
          $cfExe = "C:\cloudflared\cloudflared.exe"
          Write-Host "üöÄ Starting Cloudflare Tunnel for noVNC..."
          Start-Process -FilePath $cfExe -ArgumentList "tunnel", "--url", "http://localhost:5900" -WindowStyle Hidden
          Start-Sleep -Seconds 10
          Write-Host "üåê Check Cloudflared logs for your public noVNC URL"
