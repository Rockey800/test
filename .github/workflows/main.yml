      - name: Stream to Telegram (veryfast + instant start)
        run: |
          retries=0
          max_retries=12

          while [ $retries -lt $max_retries ]; do
            echo "=== Stream attempt $((retries+1)) / $max_retries ==="

            ffmpeg \
              -f x11grab -draw_mouse 0 -video_size 1280x720 -framerate 30 -i :99.0 \
              -f pulse -i default -ac 2 -ar 44100 \
              \
              -c:v libx264 -preset veryfast -tune zerolatency \
              -b:v 1800k -maxrate 2000k -bufsize 4000k \
              -vf "format=yuv420p,scale=1280:720" \
              -g 60 -keyint_min 30 -bf 0 \
              -c:a aac -b:a 128k \
              \
              -f flv \
              -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 \
              -flvflags no_duration_filesize \
              "$TELEGRAM_SOURCE_URL" > ffmpeg.log 2>&1 &

            FFMPEG_PID=$!
            echo "ffmpeg started (PID: $FFMPEG_PID)"

            # Health check
            elapsed=0
            while kill -0 $FFMPEG_PID 2>/dev/null; do
              sleep 30
              elapsed=$((elapsed+30))
              echo "Stream alive: ${elapsed}s"
            done

            wait $FFMPEG_PID
            exit_code=$?

            cat ffmpeg.log | tail -n 20

            if [ $exit_code -eq 0 ]; then
              echo "Stream ended cleanly."
              break
            else
              retries=$((retries+1))
              echo "Failed (code $exit_code). Retry $retries in 5s..."
              sleep 5
            fi
          done

          [ $retries -eq $max_retries ] && echo "All retries failed!" && exit 1