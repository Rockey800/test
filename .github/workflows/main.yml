name: IPTV â†’ ffmpeg â†’ Telegram Live (720p veryfast 3h stable)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # GitHub 6h limit, 3h actual stream

    env:
      IPTV_SOURCE: ${{ secrets.IPTV_SOURCE }}
      TELEGRAM_SOURCE_URL: ${{ secrets.TELEGRAM_SOURCE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y \
            mpv ffmpeg pulseaudio-utils alsa-utils xvfb x11-utils xkb-data

      - name: Start virtual display and PulseAudio
        run: |
          echo "ğŸ§ Starting virtual display and audio..."
          Xvfb :99 -screen 0 1280x720x24 +extension GLX +render -nolisten tcp &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          pulseaudio --start --exit-idle-time=-1 || true
          sleep 3
          echo "âœ… PulseAudio started"

      - name: Launch mpv (local player output)
        run: |
          echo "ğŸ¬ Starting mpv player..."
          nohup mpv "$IPTV_SOURCE" \
            --no-terminal \
            --really-quiet \
            --geometry=1280x720 \
            --loop=inf \
            --vo=x11 \
            --audio-device=pulse \
            --profile=low-latency \
            --cache=no \
            --demuxer-lavf-o=analyzeduration=1M,probesize=1M \
            > mpv.log 2>&1 &
          sleep 8
          if ! pgrep -x mpv >/dev/null; then
            echo "âŒ mpv failed to start!"
            cat mpv.log
            exit 1
          fi
          echo "âœ… mpv started successfully"

      - name: Stream screen + audio to Telegram (veryfast)
        run: |
          echo "ğŸ¥ Starting ffmpeg screen capture..."
          nohup ffmpeg \
            -f x11grab -draw_mouse 0 -video_size 1280x720 -framerate 30 -i :99.0 \
            -f pulse -i default -ac 2 -ar 44100 \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 3000k -maxrate 3500k -bufsize 6000k \
            -g 60 -keyint_min 30 -sc_threshold 0 \
            -vf "format=yuv420p" \
            -c:a aac -b:a 128k \
            -f flv "$TELEGRAM_SOURCE_URL" > ffmpeg.log 2>&1 &

          echo $! > ffmpeg.pid
          echo "âœ… Stream started, ffmpeg PID=$(cat ffmpeg.pid)"
          echo "Keeping live for 3 hours..."

          for i in $(seq 1 540); do # 540 Ã— 20s = 3 hours
            sleep 20
            if ! kill -0 $(cat ffmpeg.pid) 2>/dev/null; then
              echo "âŒ ffmpeg exited unexpectedly."
              tail -n 30 ffmpeg.log || true
              exit 1
            fi
            echo "ğŸ“¡ Stream running... $(date)"
          done

          echo "âœ… 3-hour session finished cleanly."
